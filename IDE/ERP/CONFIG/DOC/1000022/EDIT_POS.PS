{$IFNDEF PEAKTOP:OBJ/TXCDBLABEL.INC}                       {$I PEAKTOP:OBJ/TXCDBLABEL.INC}                       {$ENDIF}
{$IFNDEF PEAKTOP:OBJ/TLABEL.INC}                           {$I PEAKTOP:OBJ/TLABEL.INC}                           {$ENDIF}
{$IFNDEF PEAKTOP:OBJ/TXCEDITCALC.INC}                      {$I PEAKTOP:OBJ/TXCEDITCALC.INC}                      {$ENDIF}
{$IFNDEF PEAKTOP:OBJ/TXCEDITCOMBO.INC}                     {$I PEAKTOP:OBJ/TXCEDITCOMBO.INC}                     {$ENDIF}
{$IFNDEF PEAKTOP:OBJ/TCOMBOBOX.INC}                        {$I PEAKTOP:OBJ/TCOMBOBOX.INC}                        {$ENDIF}
{$IFNDEF PEAKTOP:OBJ/TXFBDATASETS.INC}                     {$I PEAKTOP:OBJ/TXFBDATASETS.INC}                     {$ENDIF}
{$IFNDEF PEAKTOP:OBJ/TDBGRIDEH.INC}                        {$I PEAKTOP:OBJ/TDBGRIDEH.INC}                        {$ENDIF}
{$IFNDEF PEAKTOP:OBJ/TCOLUMNEH.INC}                        {$I PEAKTOP:OBJ/TCOLUMNEH.INC}                        {$ENDIF}
{$IFNDEF PEAKTOP:OBJ/TXCSTDPANEL.INC}                      {$I PEAKTOP:OBJ/TXCSTDPANEL.INC}                      {$ENDIF}
{$IFNDEF PEAKTOP:OBJ/TXCGRADIENTPANEL.INC}                 {$I PEAKTOP:OBJ/TXCGRADIENTPANEL.INC}                 {$ENDIF}
{$IFNDEF PEAKTOP:OBJ/TXCGRADIENTPANELVISTA.INC}            {$I PEAKTOP:OBJ/TXCGRADIENTPANELVISTA.INC}            {$ENDIF}
{$IFNDEF PEAKTOP:OBJ/TSPLITTER.INC}                        {$I PEAKTOP:OBJ/TSPLITTER.INC}                        {$ENDIF}
{$IFNDEF PEAKTOP:OBJ/TXCBUTTON.INC}                        {$I PEAKTOP:OBJ/TXCBUTTON.INC}                        {$ENDIF}
{$IFNDEF PEAKTOP:OBJ/TSCROLLBOX.INC}                       {$I PEAKTOP:OBJ/TSCROLLBOX.INC}                       {$ENDIF}
{$IFNDEF PEAKTOP:OBJ/TXCPAGECONTROLEX.INC}                 {$I PEAKTOP:OBJ/TXCPAGECONTROLEX.INC}                 {$ENDIF}
{$IFNDEF PEAKTOP:OBJ/TXCTABSHEET.INC}                      {$I PEAKTOP:OBJ/TXCTABSHEET.INC}                      {$ENDIF}
{$IFNDEF PEAKTOP:IDE/ERP/DBO/SHORTCUTS.INC}                {$I PEAKTOP:IDE/ERP/DBO/SHORTCUTS.INC}                {$ENDIF}
{$IFNDEF PEAKTOP:IDE/ERP/DBO/$COMMON/FORMERP_LANG.INC}     {$I PEAKTOP:IDE/ERP/DBO/$COMMON/FORMERP_LANG.INC}     {$ENDIF}
{$IFNDEF PEAKTOP:IDE/ERP/DBO/$COMMON/FORMERP.INC}          {$I PEAKTOP:IDE/ERP/DBO/$COMMON/FORMERP.INC}          {$ENDIF}
{$IFNDEF PEAKTOP:IDE/ERP/DBO/USERS/GLOBALVARIABLES.INC}    {$I PEAKTOP:IDE/ERP/DBO/USERS/GLOBALVARIABLES.INC}    {$ENDIF}
{$IFNDEF PEAKTOP:IDE/ERP/DBO/USERS/RIGHTS.INC}             {$I PEAKTOP:IDE/ERP/DBO/USERS/RIGHTS.INC}             {$ENDIF}
{$IFNDEF PEAKTOP:IDE/ERP/DBO/DBGRID/ACTIONS.INC}           {$I PEAKTOP:IDE/ERP/DBO/DBGRID/ACTIONS.INC}           {$ENDIF}
{$IFNDEF PEAKTOP:IDE/ERP/DBO/OPER/DIALOGQUANT.INC}         {$I PEAKTOP:IDE/ERP/DBO/OPER/DIALOGQUANT.INC}         {$ENDIF}
{$IFNDEF PEAKTOP:IDE/ERP/DBO/DOC/INTF_COMENTS.INC}         {$I PEAKTOP:IDE/ERP/DBO/DOC/INTF_COMENTS.INC}         {$ENDIF}
{$IFNDEF PEAKTOP:IDE/ERP/DBO/REF/DIALOGCASEREFITEM.02.INC} {$I PEAKTOP:IDE/ERP/DBO/REF/DIALOGCASEREFITEM.02.INC} {$ENDIF}

const
  DefaultButtonWidth  = 120;
  DefaultButtonHeight = 48;
  DefaultItemWidth    = 200;
  DefaultItemHeight   = 64;
  DefaultClickHeight  = 24;
var
  MaterialColors :array[0..9]of Integer;
  //============================================================================
  function MaterialColor(const anIndex: Integer): Integer;
  var
    LIndex :Integer;
  begin
    LIndex := anIndex;
    if(LIndex >= Length(MaterialColors) )then
      LIndex := anIndex mod Length(MaterialColors);
    Result := MaterialColors[LIndex];
  end;
  //============================================================================
  procedure TERPFormGrid_CloseDataSets(aOwner :TComponent);
  var
    lkSettings :TStrings;
  begin
    lkSettings := TERPForm_Settings(aOwner);
    if(TERPForm_TransactionMain(aOwner).InTransaction)then
      begin
      with TERPForm_DataSetMain(aOwner) do
        if Active then
          begin
          if(State <> dsBrowse)then
            try
              Post;
            except
              Cancel;
            end;
          Close;   
          end;
      TERPForm_TransactionMain(aOwner).Commit;
      end;
  end;
  //============================================================================
  procedure TERPFormDocEditor_RefreshView(aOwner :TComponent);
  begin
    TERPFormGrid_CloseDataSets(aOwner);
    with TERPForm_DataSetMain(aOwner) do
      begin
      SelectSQL.Text  := StringsLoadFromFile(StrAbsolutePath('../1000014/DOCSQLHEADER001.SQL', ScriptName));
      RefreshSQL.Text := StringsLoadFromFile(StrAbsolutePath('../1000014/DOCSQLHEADER001.SQL', ScriptName));
      ModifySQL.Text  := 
        'UPDATE TABL$J_4 J SET '+SQLCRLF+
        '   J.DATE_COMMIT = ?DATE_COMMIT '+SQLCRLF+
        '  ,J.DATE_IN     = ?DATE_IN '+SQLCRLF+
        '  ,J.DOCNUMBERIN = ?DOCNUMBERIN '+SQLCRLF+
        '  ,J.NAME        = ?NAME '+SQLCRLF+
        'WHERE (J.ID = ?ID)';
      Prepare;
      ParamByName('J_ID').AsString := TERPForm_Settings(aOwner).Values[ERP_DATASET_DBKEY]; 
      try
        Open;
      except
      end;
      end;
  end;
  //============================================================================
  procedure TERPFormDocEditor_dtsMain_AfterOpen(DataSet :TDataSet);
  var
    i :Integer;
    lkCapt :string;
  begin
    TERPForm_OpenDataSetsChilds(DataSet);
    lkCapt := DataSet.FieldByName('TYPE_ID_').AsString + ' ' + DataSet.FieldByName('DOCNUMBERSTR').AsString;
    TERPForm_SetCaption(DataSet.Owner.Owner, lkCapt);
    with TxcStdPanel(DataSet.Owner.Owner.FindComponent('pnlDocHeader')) do
      begin
      Color      := DataSet.FieldByName('COLOR_BGR').AsInteger;
      Font.Color := DataSet.FieldByName('COLOR_FRG').AsInteger;
      end;
    with DataSet.Owner.Owner do
      for i:=0 to ComponentCount-1 do
        begin
        if( (Pos(UpperCase(obj_name_erp_data_dbgdata), UpperCase(Components[i].Name)) = 1) and ObjectInheritsFrom(Components[i],'TDBGridEh') )then
          begin
          TDBGridEh(Components[i]).Enabled := (DataSet.FieldByName('FLAG_COMMIT').AsInteger <> 1); 
          end;
        if ObjectInheritsFrom(Components[i],'TCustomDBEditEh') then
          TCustomDBEditEh(Components[i]).Enabled := (DataSet.FieldByName('FLAG_COMMIT').AsInteger <> 1);
        end;
  end;
  //============================================================================
  procedure TERPFormDocEditor_dtsMain_BeforeClose(DataSet :TDataSet);
  begin
    TERPForm_CloseDataSetsChilds(DataSet);
  end;
  //============================================================================
  procedure TERPFormDocEditor_mtData_OnFieldChange(Sender: TField); forward;
  //============================================================================
  procedure TERPFormDocEditor_dbgData_SelectColumn(Sender: TDBGridEh; aFieldName:string);
  var
    i :Integer;
  begin
    for i:=0 to Sender.Columns.Count-1 do
      if(Sender.Columns[i].FieldName = aFieldName)then
        break;
    Sender.SelectedIndex := i;
    Sender.SetFocus;
  end;
  //============================================================================
  procedure TERPFormDocEditor_mtData_SetEvents(DataSet :TDataSet);
  var
    i:Integer;
  begin
    for i:=1 to DataSet.Fields.Count-1 do
      if(  (DataSet.Fields[i].FieldName = 'TMC_ID')
         or(DataSet.Fields[i].FieldName = 'TMC_ARTICLE')
         or(DataSet.Fields[i].FieldName = 'TMC_BARCODE')
         or(DataSet.Fields[i].FieldName = 'PRICE')
         or(DataSet.Fields[i].FieldName = 'QUANT')
         or(DataSet.Fields[i].FieldName = 'PRICE_TMC')
      )then
        DataSet.Fields[i].OnChange := @TERPFormDocEditor_mtData_OnFieldChange;
  end;
  //============================================================================
  procedure TERPFormDocEditor_mtData_SetEventsClear(DataSet :TDataSet);
  var
    i:Integer;
  begin
    for i:=1 to DataSet.Fields.Count-1 do
      DataSet.Fields[i].OnChange := nil;
  end;
  //============================================================================
  procedure TERPFormDocEditor_mtData_OnNewRecord(DataSet :TDataSet);
  begin
    TERPFormDocEditor_mtData_SetEventsClear(DataSet);
    DataSet.FieldByName('J_ID'       ).AsString := TERPForm_Settings( TERPForm_GetOwner(DataSet) ).Values[ERP_DATASET_DBKEY];
    DataSet.FieldByName('TMC_ID'     ).AsString := '0';
    DataSet.FieldByName('TMC_NAME'   ).AsString := '';
    DataSet.FieldByName('TMC_NAME2'  ).AsString := '';
    DataSet.FieldByName('TMC_ARTICLE').AsString := '';
    DataSet.FieldByName('TMC_BARCODE').AsString := '';
    DataSet.FieldByName('EDIZM_SHORT').AsString := '';
    DataSet.FieldByName('PRICE'      ).AsString := '0';
    DataSet.FieldByName('QUANT'      ).AsString := '1';
    DataSet.FieldByName('TOTAL'      ).AsString := '0';
    DataSet.FieldByName('PRICE_TMC'  ).AsString := '0';
    DataSet.FieldByName('PCPRICE'    ).AsString := '0';
    TERPFormDocEditor_mtData_SetEvents(DataSet);
    TERPFormDocEditor_dbgData_SelectColumn(TDBGridEh(TERPForm_GetOwner(DataSet).FindComponent(obj_name_erp_data_dbgdata)), 'TMC_ID');
  end;
  //============================================================================
  procedure TERPFormDocEditor_mtData_FillRecords(DataSet :TDataSet; aTMC_ID:string);
  var
    lkSQL        :string;
    lkStr        :string;
    lkRefFields  :array of string;
  begin
    SetLength(lkRefFields, 8);
    lkSQL := 
      'SELECT R.ID AS TMC_ID, R.NAME AS TMC_NAME, R.NAME2 AS TMC_NAME2, R.ARTICLE AS TMC_ARTICLE, R.BARCODE AS TMC_BARCODE '+SQLCRLF+
      '      ,E.SHORT_NAME AS EDIZM_SHORT '+SQLCRLF+
      '      ,P.PRICE AS TMC_PRICE, P.PRICE_IN AS TMC_PRICE_IN '+SQLCRLF+
      'FROM  TABL$R_TMC R '+SQLCRLF+
      '        LEFT OUTER JOIN TABL$R_EDIZM E ON (E.ID     = R.EDIZM_ID) '+SQLCRLF+
      '        LEFT OUTER JOIN TABL$R_TMC_P P ON (P.TMC_ID = R.ID      ) AND (P.VALUE_DATE = R.VALUE_DATE) '+SQLCRLF+
      'WHERE (R.ID = '''+aTMC_ID+''') ';
    if TERPForm_SelectSQLParams([], lkSQL, [],[], ['TMC_ID', 'TMC_NAME', 'TMC_NAME2', 'TMC_ARTICLE', 'TMC_BARCODE', 'EDIZM_SHORT', 'TMC_PRICE', 'TMC_PRICE_IN'], lkRefFields)then
      begin
      DataSet.FieldByName('TMC_ID'     ).AsString := aTMC_ID;
      DataSet.FieldByName('TMC_NAME'   ).AsString := lkRefFields[1];
      DataSet.FieldByName('TMC_NAME2'  ).AsString := lkRefFields[2];
      DataSet.FieldByName('TMC_ARTICLE').AsString := lkRefFields[3];
      DataSet.FieldByName('TMC_BARCODE').AsString := lkRefFields[4];
      DataSet.FieldByName('EDIZM_SHORT').AsString := lkRefFields[5];
      DataSet.FieldByName('PRICE'      ).AsString := lkRefFields[7];
      DataSet.FieldByName('PRICE_TMC'  ).AsString := lkRefFields[6];
      DataSet.FieldByName('TOTAL'      ).AsFloat  := DataSet.FieldByName('PRICE').AsFloat * DataSet.FieldByName('QUANT').AsFloat;
      if(DataSet.FieldByName('PRICE').AsFloat <>  0)then
        DataSet.FieldByName('PCPRICE').AsFloat := DataSet.FieldByName('PRICE_TMC').AsFloat * 100 / DataSet.FieldByName('PRICE').AsFloat - 100
       else
        DataSet.FieldByName('PCPRICE').AsFloat := 0; 
      end;
    SetLength(lkRefFields, 0);
  end;
  //============================================================================
  procedure TERPFormDocEditor_mtData_OnFieldChange(Sender: TField);
  var
    i            :Integer;
    lkFld        :string;
    lkStr        :string;
    lkTMC_ID     :string;
    lkDBG        :TDBGridEh;
  label
    LabelContinue;  
  begin
    TERPFormDocEditor_mtData_SetEventsClear(Sender.DataSet);
    lkDBG  := TDBGridEh(TERPForm_GetOwner(Sender).FindComponent(obj_name_erp_data_dbgdata));
    lkFld  := UpperCase( StrTrimAll( Sender.FieldName ) );
    if( (lkFld = 'TMC_ID') or (lkFld = 'TMC_ARTICLE') or (lkFld = 'TMC_BARCODE') )then
      begin
      lkTMC_ID := '0';
           if(lkFld = 'TMC_ID')then
             begin
             lkTMC_ID := Sender.AsString;
             GetField(FBDataBase, 'TABL$R_TMC', 'COALESCE( COUNT(ID), 0)', 'ID = '''+lkTMC_ID+''' ', lkStr);
             if(not(StrToInt(lkStr) > 0))then
               begin
               Dialogs.MessageDlg('ТМЦ с кодом "'+lkTMC_ID+'" не найдено! ', mtWarning, [mbOK]);
               TERPFormDocEditor_dbgData_SelectColumn(lkDBG, 'TMC_ID');
               goto LabelContinue;
               end
             end
      else if(lkFld = 'TMC_ARTICLE')then
             begin
             lkTMC_ID := '0';
             GetField(FBDataBase, 'TABL$R_TMC', 'COALESCE( COUNT(ID), 0)', 'TRIM(UPPER(ARTICLE)) = '''+StrReplaceStr(AnsiUpperCase(Sender.AsString), '''', '''''')+''' ', lkStr);
             if(not(StrToInt(lkStr) > 0))then
               begin
               Dialogs.MessageDlg('ТМЦ с артикулом "'+Sender.AsString+'" не найдено! ', mtWarning, [mbOK]);
               TERPFormDocEditor_dbgData_SelectColumn(lkDBG, 'TMC_ARTICLE');
               goto LabelContinue;
               end
             GetField(FBDataBase, 'TABL$R_TMC', 'ID', 'TRIM(UPPER(ARTICLE)) = '''+StrReplaceStr(AnsiUpperCase(Sender.AsString), '''', '''''')+''' ', lkTMC_ID);
             end  
      else if(lkFld = 'TMC_BARCODE')then
             begin
             lkTMC_ID := '0';
             GetField(FBDataBase, 'TABL$R_TMC', 'COALESCE( COUNT(ID), 0)', 'TRIM(BARCODE) = '''+StrReplaceStr(AnsiUpperCase(Sender.AsString), '''', '''''')+''' ', lkStr);
             if(not(StrToInt(lkStr) > 0))then
               begin
               Dialogs.MessageDlg('ТМЦ со штрихкодом "'+Sender.AsString+'" не найдено! ', mtWarning, [mbOK]);
               TERPFormDocEditor_dbgData_SelectColumn(lkDBG, 'TMC_BARCODE');
               goto LabelContinue;
               end
             GetField(FBDataBase, 'TABL$R_TMC', 'ID', 'TRIM(BARCODE) = '''+StrReplaceStr(AnsiUpperCase(Sender.AsString), '''', '''''')+''' ', lkTMC_ID);
             end  
      TERPFormDocEditor_mtData_FillRecords(Sender.DataSet, lkTMC_ID);
      TERPFormDocEditor_dbgData_SelectColumn(lkDBG, 'PRICE');
      end;
    if(lkFld = 'PRICE')then
      begin
      Sender.DataSet.FieldByName('TOTAL'      ).AsFloat  := Sender.DataSet.FieldByName('PRICE').AsFloat * Sender.DataSet.FieldByName('QUANT').AsFloat;
      if(Sender.DataSet.FieldByName('PRICE').AsFloat <>  0)then
        Sender.DataSet.FieldByName('PCPRICE').AsFloat := Sender.DataSet.FieldByName('PRICE_TMC').AsFloat * 100 / Sender.DataSet.FieldByName('PRICE').AsFloat - 100;
      TERPFormDocEditor_dbgData_SelectColumn(lkDBG, 'QUANT');
      end;
    if(lkFld = 'QUANT')then
      begin
      Sender.DataSet.FieldByName('TOTAL'      ).AsFloat  := Sender.DataSet.FieldByName('PRICE').AsFloat * Sender.DataSet.FieldByName('QUANT').AsFloat;
      TERPFormDocEditor_dbgData_SelectColumn(lkDBG, 'PRICE_TMC');
      end;
    if(lkFld = 'PRICE_TMC')then
      begin
      if(Sender.DataSet.FieldByName('PRICE').AsFloat <>  0)then
        Sender.DataSet.FieldByName('PCPRICE').AsFloat := Sender.DataSet.FieldByName('PRICE_TMC').AsFloat * 100 / Sender.DataSet.FieldByName('PRICE').AsFloat - 100;
      if(Sender.DataSet.State <> dsBrowse)then
        Sender.DataSet.Post;
      //TERPFormDocEditor_dbgData_SelectColumn(lkDBG, 'PRICE_TMC');
      end;
  LabelContinue:  
    TERPFormDocEditor_mtData_SetEvents(Sender.DataSet);
  end;
  //============================================================================
  procedure TERPFormDocEditor_mtData_AfterOpen(DataSet :TDataSet);
  begin
    TERPFormDocEditor_mtData_SetEvents(DataSet);
    if(DataSet.Tag <> 0)then
      DataSet.RecNo := DataSet.Tag;    
    TERPForm_OpenDataSetsChilds(DataSet);
  end;
  //============================================================================
  procedure TERPFormDocEditor_mtData_BeforeClose(DataSet :TDataSet);
  begin
    DataSet.Tag := DataSet.RecNo;    
    TERPForm_CloseDataSetsChilds(DataSet);
  end;
  //============================================================================
  procedure TERPFormDocEditor_actRefresh_OnExecute(Sender :TObject);
  begin
    TERPFormDocEditor_RefreshView(TComponent(Sender).Owner);
  end;
  //============================================================================
  procedure TERPFormDocEditor_actCommit_OnExecute(Sender :TObject);
  begin
    TERPFormDocEditor_RefreshView(TComponent(Sender).Owner);
    if not (Dialogs.MessageDlg('Провести документ ?', mtConfirmation, [mbYes, mbNo]) = mrYes)then exit;
    TERPForm_ExecSQL([], 'UPDATE TABL$J_4 J SET J.FLAG_COMMIT = 1 WHERE (J.ID = '''+TERPForm_Settings(TComponent(Sender).Owner).Values[ERP_DATASET_DBKEY]+''')');
    TERPFormDocEditor_RefreshView(TComponent(Sender).Owner);
  end;
  //============================================================================
  procedure TERPFormDocEditor_actCommit_OnUpdate(Sender :TObject);
  var
    lkEnabled :Boolean;
  begin
    with TERPForm_DataSetMain(TComponent(Sender).Owner) do
      begin
      lkEnabled := Active;
      if lkEnabled then lkEnabled   := (RecordCount > 0);
      if lkEnabled then lkEnabled   := (FieldByName('FLAG_COMMIT').AsInteger = 0);
      TCustomAction(Sender).Enabled := lkEnabled;
      end;
  end;
  //============================================================================
  procedure TERPFormDocEditor_actUnCommit_OnExecute(Sender :TObject);
  begin
    TERPFormDocEditor_RefreshView(TComponent(Sender).Owner);
    if not (Dialogs.MessageDlg('Отменить проведение документа ?', mtConfirmation, [mbYes, mbNo]) = mrYes)then exit;
    TERPForm_ExecSQL([], 'UPDATE TABL$J_4 J SET J.FLAG_COMMIT = 0 WHERE (J.ID = '''+TERPForm_Settings(TComponent(Sender).Owner).Values[ERP_DATASET_DBKEY]+''')');
    TERPFormDocEditor_RefreshView(TComponent(Sender).Owner);
  end;
  //============================================================================
  procedure TERPFormDocEditor_actUnCommit_OnUpdate(Sender :TObject);
  var
    lkEnabled :Boolean;
  begin
    with TERPForm_DataSetMain(TComponent(Sender).Owner) do
      begin
      lkEnabled := Active;
      if lkEnabled then lkEnabled   := (RecordCount > 0);
      if lkEnabled then lkEnabled   := (FieldByName('FLAG_COMMIT').AsInteger <> 0);
      TCustomAction(Sender).Enabled := lkEnabled;
      end;
  end;
  //============================================================================
  procedure TERPFormDocEditor_actTMCDel_OnExecute(Sender :TObject);
  var
    lkSQL  :string;
    i      :Integer;
    lkDBG  :TDBGridEh;
  begin
    lkDBG := TDBGridEh(TComponent(Sender).Owner.FindComponent(obj_name_erp_data_dbgdata));
    with lkDBG.DataSource.DataSet do
      begin
      if not Active then exit;  
      if not(RecordCount>0)then exit;  
      if(Dialogs.MessageDlg('Удалить выбранные позиции из документа ?',mtConfirmation, [mbYes, mbNo]) <> mrYes)then exit;
      end;
    if(lkDBG.SelectedRows.Count > 0)then
      begin
      lkDBG.DataSource.DataSet.DisableControls;
      lkDBG.SaveBookMark; 
      lkSQL := 'DELETE FROM TABL$D_1000014 D WHERE (D.ID IN ('+lkDBG.DataSource.DataSet.FieldByName('ID').AsString;
      for i:=0 to lkDBG.SelectedRows.Count-1 do
        begin
        lkDBG.DataSource.DataSet.Bookmark := lkDBG.SelectedRows[i];
        lkSQL := lkSQL + ', '+lkDBG.DataSource.DataSet.FieldByName('ID').AsString;
        end;
      lkSQL := lkSQL + ') ); ';
      lkDBG.RestoreBookMark; 
      lkDBG.DataSource.DataSet.EnableControls;
      end
     else 
      lkSQL := 'DELETE FROM TABL$D_1000014 D WHERE (D.ID = '''+lkDBG.DataSource.DataSet.FieldByName('ID').AsString+''')';
    TERPFormGrid_CloseDataSets(TComponent(Sender).Owner);
    TERPForm_ExecSQL([], lkSQL);
    TERPFormDocEditor_RefreshView(TComponent(Sender).Owner);
  end;
  //============================================================================
  procedure TERPFormDocEditor_U_TYPE_ID(aDBE:TDBEditEh);
  var
    lkID, lkJ_ID :string;
  begin
    if(not(aDBE.DataSource.DataSet.RecordCount > 0))then exit;
    if(aDBE.DataSource.DataSet.FieldByName('FLAG_COMMIT').AsInteger <> 0)then exit;
    lkJ_ID := aDBE.DataSource.DataSet.FieldByName('ID').AsString;
    lkID   := aDBE.DataSource.DataSet.FieldByName('TYPE_ID').AsString;
    if not  ERPDialogCaseItem02_Execute(
      'SELECT R.ID, R.NAME2 AS NAME FROM TABL$_TB_TYPES R WHERE R.ID IN (1000022, 1000026, 1000027, 1000071) ', 
      'Доступные типы документов', 'Выберите тип документа:', ERP_ObjectIcon(ERP_OBJECTTYPE_DOC), ERP_ObjectBitmap(ERP_OBJECTTYPE_DOC), lkID) then exit;
    TERPFormGrid_CloseDataSets(aDBE.Owner);
    ExecSQL(TERPForm_DataSetMain(aDBE.Owner).DataBase, 
      'EXECUTE BLOCK AS '+SQLCRLF+
      '  DECLARE VARIABLE P_FIRM_ID   TYPE OF COLUMN TABL$J_4.FIRM_ID; '+SQLCRLF+
      '  DECLARE VARIABLE P_DOCNUMBER TYPE OF COLUMN TABL$J_4.DOCNUMBER; '+SQLCRLF+
      'BEGIN '+SQLCRLF+
      '  SELECT FIRST 1 J.FIRM_ID FROM TABL$J_4 J WHERE (J.ID = '''+lkJ_ID+''') INTO :P_FIRM_ID; '+SQLCRLF+
      '  SELECT FIRST 1 P.NEW_NUMBER FROM PROC$J_GEN_4('''+lkID+''', :P_FIRM_ID) P INTO :P_DOCNUMBER; '+SQLCRLF+
      '  UPDATE TABL$J_4 J SET '+SQLCRLF+
      '    J.TYPE_ID   = '''+lkID+''' '+SQLCRLF+
      '   ,J.DOCNUMBER = :P_DOCNUMBER '+SQLCRLF+
      '  WHERE (J.ID = '''+lkJ_ID+'''); '+SQLCRLF+
      'END'+SQLCRLF
    );
    TERPFormDocEditor_RefreshView(aDBE.Owner);
  end;
  //============================================================================
  procedure TERPFormDocEditor_dbeTYPE_ID__OnButtonClick(Sender :TObject; var Handled : Boolean);
  begin
    Handled := true;
    TERPFormDocEditor_U_TYPE_ID(TDBEditEh(TComponent(Sender).Owner));
  end; 
  //============================================================================
  procedure TERPFormDocEditor_dbeTYPE_ID__OnDblClick(Sender :TObject);
  begin
    TERPFormDocEditor_U_TYPE_ID( TDBEditEh(Sender) );
  end; 
  //============================================================================
  procedure TERPFormDocEditor_U_FIRM_ID(aDBE:TDBEditEh);
  var
    lkID, lkJ_ID :string;
  begin
    if(not(aDBE.DataSource.DataSet.RecordCount > 0))then exit;
    if(aDBE.DataSource.DataSet.FieldByName('FLAG_COMMIT').AsInteger <> 0)then exit;
    lkJ_ID := aDBE.DataSource.DataSet.FieldByName('ID').AsString;
    lkID   := aDBE.DataSource.DataSet.FieldByName('FIRM_ID').AsString;
    if not  ERPDialogCaseItem02_Execute(
      'SELECT R.ID, R.NAME FROM TABL$R_FIRMS R WHERE (R.FLAG_DELETE <> 1) ', 
      'Доступные фирмы учёта', 'Выберите фирму учёта:', ERP_ObjectIcon(ERP_OBJECTTYPE_REF), ERP_ObjectBitmap(ERP_OBJECTTYPE_REF), lkID) then exit;
    TERPFormGrid_CloseDataSets(aDBE.Owner);
    ExecSQL(TERPForm_DataSetMain(aDBE.Owner).DataBase, 
      'EXECUTE BLOCK AS '+SQLCRLF+
      '  DECLARE VARIABLE P_TYPE_ID   TYPE OF COLUMN TABL$J_4.TYPE_ID; '+SQLCRLF+
      '  DECLARE VARIABLE P_DOCNUMBER TYPE OF COLUMN TABL$J_4.DOCNUMBER; '+SQLCRLF+
      'BEGIN '+SQLCRLF+
      '  SELECT FIRST 1 J.TYPE_ID FROM TABL$J_4 J WHERE(J.ID = '''+lkJ_ID+''') INTO :P_TYPE_ID; '+SQLCRLF+
      '  SELECT FIRST 1 P.NEW_NUMBER FROM PROC$J_GEN_4(:P_TYPE_ID, '''+lkID+''') P INTO :P_DOCNUMBER; '+SQLCRLF+
      '  UPDATE TABL$J_4 J SET '+SQLCRLF+
      '    J.FIRM_ID   = '''+lkID+''' '+SQLCRLF+
      '   ,J.DOCNUMBER = :P_DOCNUMBER '+SQLCRLF+
      '  WHERE (J.ID = '''+lkJ_ID+'''); '+SQLCRLF+
      'END'+SQLCRLF
    );
    TERPFormDocEditor_RefreshView(aDBE.Owner);
  end;
  //============================================================================
  procedure TERPFormDocEditor_dbeFIRM_ID__OnButtonClick(Sender :TObject; var Handled : Boolean);
  begin
    Handled := true;
    TERPFormDocEditor_U_FIRM_ID( TDBEditEh(TComponent(Sender).Owner) );
  end; 
  //============================================================================
  procedure TERPFormDocEditor_dbeFIRM_ID__OnDblClick(Sender :TObject);
  begin
    TERPFormDocEditor_U_FIRM_ID( TDBEditEh(Sender) );
  end; 
  //============================================================================
  procedure TERPFormDocEditor_U_FILIAL_ID(aDBE:TDBEditEh);
  var
    lkID, lkJ_ID :string;
  begin
    if(not(aDBE.DataSource.DataSet.RecordCount > 0))then exit;
    if(aDBE.DataSource.DataSet.FieldByName('FLAG_COMMIT').AsInteger <> 0)then exit;
    lkJ_ID := aDBE.DataSource.DataSet.FieldByName('ID').AsString;
    lkID   := aDBE.DataSource.DataSet.FieldByName('FILIAL_ID').AsString;
    if not  ERPDialogCaseItem02_Execute(
      'SELECT R.ID, R.NAME FROM TABL$R_FILIALS R WHERE (R.FLAG_DELETE <> 1) ', 
      'Доступные филиалы', 'Выберите филиал:', ERP_ObjectIcon(ERP_OBJECTTYPE_REF), ERP_ObjectBitmap(ERP_OBJECTTYPE_REF), lkID) then exit;
    TERPFormGrid_CloseDataSets(aDBE.Owner);
    ExecSQL(TERPForm_DataSetMain(aDBE.Owner).DataBase, 'UPDATE TABL$J_4 J SET J.FILIAL_ID = '''+lkID+''' WHERE (J.ID = '''+lkJ_ID+''') ');
    TERPFormDocEditor_RefreshView(aDBE.Owner);
  end;
  //============================================================================
  procedure TERPFormDocEditor_dbeFILIAL_ID__OnButtonClick(Sender :TObject; var Handled : Boolean);
  begin
    Handled := true;
    TERPFormDocEditor_U_FILIAL_ID( TDBEditEh(TComponent(Sender).Owner) );
  end; 
  //============================================================================
  procedure TERPFormDocEditor_dbeFILIAL_ID__OnDblClick(Sender :TObject);
  begin
    TERPFormDocEditor_U_FILIAL_ID( TDBEditEh(Sender) );
  end; 
  //============================================================================
  procedure TERPFormDocEditor_U_CS_ID(aDBE:TDBEditEh);
  var
    lkID, lkJ_ID :string;
  begin
    if(not(aDBE.DataSource.DataSet.RecordCount > 0))then exit;
    if(aDBE.DataSource.DataSet.FieldByName('FLAG_COMMIT').AsInteger <> 0)then exit;
    lkJ_ID := aDBE.DataSource.DataSet.FieldByName('ID').AsString;
    lkID   := aDBE.DataSource.DataSet.FieldByName('CS_ID').AsString;
    SetGlobalVariable('CS_ID', lkID);
    call(StrAbsolutePath('../../REF/CS/DEFAULT_DLG.PS', ScriptName));
    lkID := GetGlobalVariable('CS_ID');
    if( (lkID = 'NULL') or (StrTrimAll(lkID) = '') )then exit;
    TERPFormGrid_CloseDataSets(aDBE.Owner);
    ExecSQL(TERPForm_DataSetMain(aDBE.Owner).DataBase, 
      '  UPDATE TABL$J_1000014 J SET '+SQLCRLF+
      '    J.CS_ID   = '''+lkID+''' '+SQLCRLF+
      '  WHERE (J.J_ID = '''+lkJ_ID+'''); '+SQLCRLF
    );
    TERPFormDocEditor_RefreshView(aDBE.Owner);
  end;
  //============================================================================
  procedure TERPFormDocEditor_dbeCS_ID__OnButtonClick(Sender :TObject; var Handled : Boolean);
  begin
    Handled := true;
    TERPFormDocEditor_U_CS_ID( TDBEditEh(TComponent(Sender).Owner) );
  end; 
  //============================================================================
  procedure TERPFormDocEditor_dbeCS_ID__OnDblClick(Sender :TObject);
  begin
    TERPFormDocEditor_U_CS_ID( TDBEditEh(Sender) );
  end; 
  //============================================================================
  procedure TERPFormDocEditor_U_PLACE_ID(aDBE:TDBEditEh);
  var
    lkID, lkJ_ID :string;
  begin
    if(not(aDBE.DataSource.DataSet.RecordCount > 0))then exit;
    if(aDBE.DataSource.DataSet.FieldByName('FLAG_COMMIT').AsInteger <> 0)then exit;
    lkJ_ID := aDBE.DataSource.DataSet.FieldByName('ID').AsString;
    lkID   := aDBE.DataSource.DataSet.FieldByName('PLACE_ID').AsString;
    if not  ERPDialogCaseItem02_Execute(
      'SELECT R.ID, R.NAME FROM TABL$R_PLACES R WHERE (R.FLAG_DELETE <> 1) ', 
      'Доступные места хранения', 'Выберите место хранения:', ERP_ObjectIcon(ERP_OBJECTTYPE_REF), ERP_ObjectBitmap(ERP_OBJECTTYPE_REF), lkID) then exit;
    TERPFormGrid_CloseDataSets(aDBE.Owner);
    ExecSQL(TERPForm_DataSetMain(aDBE.Owner).DataBase, 
      '  UPDATE TABL$J_1000014 J SET '+SQLCRLF+
      '    J.PLACE_ID   = '''+lkID+''' '+SQLCRLF+
      '  WHERE (J.J_ID = '''+lkJ_ID+'''); '+SQLCRLF
    );
    TERPFormDocEditor_RefreshView(aDBE.Owner);
  end;
  //============================================================================
  procedure TERPFormDocEditor_dbePLACE_ID__OnButtonClick(Sender :TObject; var Handled : Boolean);
  begin
    Handled := true;
    TERPFormDocEditor_U_PLACE_ID( TDBEditEh(TComponent(Sender).Owner) );
  end; 
  //============================================================================
  procedure TERPFormDocEditor_dbePLACE_ID__OnDblClick(Sender :TObject);
  begin
    TERPFormDocEditor_U_PLACE_ID( TDBEditEh(Sender) );
  end; 
  //============================================================================
  procedure TERPFormDocEditor_U_TAX_ID(aDBE:TDBEditEh);
  var
    lkID, lkJ_ID :string;
  begin
    if(not(aDBE.DataSource.DataSet.RecordCount > 0))then exit;
    if(aDBE.DataSource.DataSet.FieldByName('FLAG_COMMIT').AsInteger <> 0)then exit;
    lkJ_ID := aDBE.DataSource.DataSet.FieldByName('ID').AsString;
    lkID   := aDBE.DataSource.DataSet.FieldByName('TAX_ID').AsString;
    if not  ERPDialogCaseItem02_Execute(
      'SELECT R.ID, R.NAME FROM TABL$R_TAXES R WHERE (R.FLAG_DELETE <> 1) AND (R.ID IN (1000008,1000009,1000010)) ', 
      'Доступные налоговые модели', 'Выберите налоговую модель:', ERP_ObjectIcon(ERP_OBJECTTYPE_REF), ERP_ObjectBitmap(ERP_OBJECTTYPE_REF), lkID) then exit;
    TERPFormGrid_CloseDataSets(aDBE.Owner);
    ExecSQL(TERPForm_DataSetMain(aDBE.Owner).DataBase, 
      '  UPDATE TABL$J_1000014 J SET '+SQLCRLF+
      '    J.TAX_ID   = '''+lkID+''' '+SQLCRLF+
      '  WHERE (J.J_ID = '''+lkJ_ID+'''); '+SQLCRLF
    );
    TERPFormDocEditor_RefreshView(aDBE.Owner);
  end;
  //============================================================================
  procedure TERPFormDocEditor_dbeTAX_ID__OnButtonClick(Sender :TObject; var Handled : Boolean);
  begin
    Handled := true;
    TERPFormDocEditor_U_TAX_ID( TDBEditEh(TComponent(Sender).Owner) );
  end; 
  //============================================================================
  procedure TERPFormDocEditor_dbeTAX_ID__OnDblClick(Sender :TObject);
  begin
    TERPFormDocEditor_U_TAX_ID( TDBEditEh(Sender) );
  end; 
  //============================================================================
  procedure TERPFormDocEditor_actTMCIns_OnExecute(Sender :TObject);
  var
    lkDTS :TDataSet;
    lkMT  :TMemTableEh;
    lkTMC :string;
  begin
    lkTMC := '0';
    call('PEAKTOP:IDE/ERP/CONFIG/REF/TMC/DEFAULT_DLG.PS');
    lkTMC := GetGlobalVariable('TMC_ID');
    if( (lkTMC = '0') or (lkTMC='NULL') )then exit;
    lkDTS := TDataSet(TERPForm_DataSetMain(TComponent(Sender).Owner).FindComponent(obj_name_erp_data_dtsdata));
    lkMT  := TMemTableEh( lkDTS.FindComponent('MemoryTable'+obj_name_erp_data_dtsdata) );
    if(lkMT.State <> dsBrowse)then
      lkMT.Post;
    lkMT.Append;
    lkMT.FieldByName('TMC_ID').AsString := lkTMC;  
  end;
  //============================================================================
  procedure TERPFormDocEditor_dbgData_TMC_NAME2_Update_OnClick(Sender :TObject; var Handled : Boolean);
  var
    lkSQL :string;
    lkDTS :TDataSet;
    lkMT  :TMemTableEh;
    lkTMC :string;
  begin
    Handled := true;
    lkDTS := TDataSet( TERPForm_DataSetMain( TERPForm_GetOwner(TComponent(Sender)) ).FindComponent(obj_name_erp_data_dtsdata) );
    lkMT  := TMemTableEh( lkDTS.FindComponent('MemoryTable'+obj_name_erp_data_dtsdata) );
    if(lkMT.RecordCount = 0)then
      lkTMC := '0'
     else 
      lkTMC := lkMT.FieldByName('TMC_ID').AsString;
    call('PEAKTOP:IDE/ERP/CONFIG/REF/TMC/DEFAULT_DLG.PS');
    lkTMC := GetGlobalVariable('TMC_ID');
    if( (lkTMC = '0') or (lkTMC='NULL') )then exit;
    if(lkMT.RecordCount = 0)then
      begin
      lkMT.Append;
      end
     else
      begin 
      if(lkMT.State = dsBrowse)then
        lkMT.Edit;
      end;
    lkMT.FieldByName('TMC_ID').AsString := lkTMC;  
  end; 
  //============================================================================
  procedure TERPFormDocEditor_actTMCNew_OnExecute(Sender :TObject);
  var
    lkTMC_GROUP_ID :string;
    lkTMC_GROUP    :string;
    lkSQL :string;
  begin
    lkTMC_GROUP_ID := '0';
    SetGlobalVariable('TMC_GROUP_ID', lkTMC_GROUP_ID);
    call('DB:CONFIG/REF/TMC_GROUP/DEFAULT_DLG.PS');
    lkTMC_GROUP_ID := GetGlobalVariable('TMC_GROUP_ID');
    if( (StrTrimAll(lkTMC_GROUP_ID)='') or  (UpperCase(lkTMC_GROUP_ID) = 'NULL') or (lkTMC_GROUP_ID = '0') )then exit;
    GetField(TERPForm_DataSetMain(TComponent(Sender).Owner).DataBase, 'TABL$R_TMC_GROUP', 'NAME', 'ID = '''+lkTMC_GROUP_ID+''' ', lkTMC_GROUP);
    lkSQL := 
      'EXECUTE BLOCK RETURNS ( '+SQLCRLF+
      '  TMC_ID TYPE OF COLUMN TABL$R_TMC.ID '+SQLCRLF+
      ')AS '+SQLCRLF+
      'BEGIN '+SQLCRLF+
      '  INSERT INTO TABL$R_TMC (NAME, NAME2, FLAG_DELETE, FLAG_LOCKED, ARTICLE, '+SQLCRLF+
      '    NUMSHOW, EDIZM_ID, TMC_GROUP_ID, TMC_TYPE_ID, TMC_LIST_ID, TMC_BRAND_ID, '+SQLCRLF+
      '    DEV_TMC_BRAND_ID, COUNTRY_ID, PROBE, LGTH, DIAM, MASSA, MASSA_NETTO, LIMIT, DEV_COUNTRY_ID '+SQLCRLF+
      '  )VALUES ('''+StrReplaceStr(lkTMC_GROUP, '''','"')+''', '''+StrReplaceStr(lkTMC_GROUP, '''','"')+''', 0, 0, '''', '''', 1000000, '''+
      lkTMC_GROUP_ID+''', 2, 0, 0, 0, 0, '''', 0, 0, 0, 0, 0, 0 '+SQLCRLF+
      '  )RETURNING ID INTO :TMC_ID; '+SQLCRLF+
//      '  INSERT INTO TABL$D_1000014(J_ID, TMC_ID, QUANT)VALUES('''+dtsJournal.FieldByName('ID').AsString+''', :TMC_ID, 1.000); '+SQLCRLF+
      '  SUSPEND; '+SQLCRLF+
      'END';  

    TERPFormGrid_CloseDataSets( TComponent(Sender).Owner );
    ExecSQL(TERPForm_DataSetMain( TComponent(Sender).Owner ).DataBase, lkSQL );
    TERPFormDocEditor_RefreshView( TComponent(Sender).Owner );
  end;
  //============================================================================
  procedure TERPFormDocEditor_actTMCEdit_OnExecute(Sender :TObject);
  var
    lkDBG   :TDBGridEh;
  begin
    lkDBG := TDBGridEh(TComponent(Sender).Owner.FindComponent(obj_name_erp_data_dbgdata));
    with lkDBG.DataSource.DataSet do
      begin
      if(RecordCount = 0)then exit;
      if(FieldByName('TMC_ID').AsInteger = 0)then exit;
      SetGlobalVariable('TMC_ID', FieldByName('TMC_ID').AsString);
      end;
    call('PEAKTOP:IDE/ERP/CONFIG/REF/TMC/DEFAULT_ITEM_DLG.PS');
    TERPFormDocEditor_RefreshView( TComponent(Sender).Owner );
  end;
  //============================================================================
  procedure TERPFormDocEditor_actPrint_OnExecute(Sender :TObject);
  var
    lkJ_ID       :string;
    lkPrintScript:string;
  begin
    lkJ_ID := TERPForm_Settings(TComponent(Sender).Owner).Values[ERP_DATASET_DBKEY];
    lkPrintScript := '../'+ TERPForm_DataSetMain(TComponent(Sender).Owner).FieldByName('TYPE_ID').AsString + '/PRINT.PS';    
    TERPFormDocEditor_RefreshView(TComponent(Sender).Owner);
    SetGlobalVariable('J_ID', lkJ_ID);
    call(StrAbsolutePath(lkPrintScript, ScriptName));
  end;
  //============================================================================
  procedure TERPFormDocEditor_actCnd_OnExecute(Sender :TObject);
  begin
    SetGlobalVariable('J_ID', TERPForm_Settings(TComponent(Sender).Owner).Values[ERP_DATASET_DBKEY]);
    call('PEAKTOP:IDE/ERP/CONFIG/REG/CND/DEFAULT_DOC.PS');
  end;
  //============================================================================
  procedure TERPFormDocEditor_actJrnl_OnExecute(Sender :TObject);
  var
    lkVarName:string;
    lkScript :string;
  begin
    lkVarName := 'J_ID'+ERP_SQL_GOTO_SUFFIX;
    if(lkVarName = '')then exit;
    with TERPForm_DataSetMain(TComponent(Sender).Owner) do
      begin
      if(not Active)then exit;
      if(not(RecordCount > 0))then exit;
      if(FindField('TYPE_ID') <> nil)then
        begin
        SetGlobalVariable(lkVarName, FieldByName(ERP_DATASET_DBKEY).AsString);
        lkScript := '{$IFNDEF PEAKTOP:IDE/ERP/DBO/DOC/FORMJRNL.INC}{$I PEAKTOP:IDE/ERP/DBO/DOC/FORMJRNL.INC}{$ENDIF} '+SQLCRLF+
                    'begin '+SQLCRLF+'  Journal_Create('''+FieldByName('TYPE_ID').AsString+'''); '+SQLCRLF+'end.';        
        run(lkScript, 'DB:CONFIG/DOC/'+FieldByName('TYPE_ID').AsString+'/DEFAULT.PS');
        end;
      end;
  end;
  //============================================================================
  procedure TERPFormDocEditor_actPrint_OnUpdate(Sender :TObject);
  begin
  end;
  //============================================================================
  procedure TERPFormDocEditor_dbgData_OnGetCellParams(Sender:TObject; Column:TColumnEh; AFont: TFont; var Background:TColor; State:TGridDrawState);
  begin
    if(Column.Tag = 666)then exit;
    if(not(Column.Field.DataSet.Active))then exit;
    if(Column.Field.DataSet.RecordCount = 0)then exit;
  end;
  //============================================================================
  procedure TERPFormDocEditor_dbgData_OnKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
  begin
    if(Shift = [ssCtrl])then
      begin
      if(Key = $2E {VK_DELETE})then TERPFormDocEditor_actTMCDel_OnExecute(Sender);
      end; 
  end;
  //============================================================================
  procedure TERPFormDocEditor_OnResize(Sender:TObject);
  var
    i          :Integer;
    lkColWidth :Integer;
  begin
    with TDBGridEh(TComponent(Sender).FindComponent(obj_name_erp_data_dbgdata)) do
      begin
      lkColWidth := 0;
      for i:=0 to Columns.Count-1 do
        if(UpperCase(Columns[i].FieldName) <> 'TMC_NAME2')then
          lkColWidth := lkColWidth + Columns[i].Width;
      for i:=0 to Columns.Count-1 do
        if(UpperCase(Columns[i].FieldName) = 'TMC_NAME2')then
          begin
          Columns[i].Width := Width - lkColWidth - 64;
          break;
          end;
      end;
  end;
  //============================================================================
  procedure TERPFormDocEditor_OnClose(Sender:TObject; var aCloseAction:TCloseAction);
  begin
    TERPFormGrid_CloseDataSets(TComponent(Sender));
    with TxFBTransaction(TComponent(Sender).FindComponent('trTMC')) do
      if InTransaction then Commit;
    aCloseAction := caFree;
  end;
  //============================================================================
  function TERPFormDocEditor_Create(const aJ_ID :string):TAmunhotepForm;
  var
    lkMainMenu    :TMainMenu;
    lkMIMenuMain  :TMenuItem;

    lkPCDoc       :TxcPageControlEx;
    lkTSDoc       :TxcTabSheet;
    lkTSComents   :TxcTabSheet;
    lkPnlDocHeader:TxcStdPanel;
    lkToolBarDoc  :TxcGradientPanelVista;
    lkLbl         :TLabel;
    lkDBE         :TCustomDBEditEh;
    lkToolBarData :TxcGradientPanelVista;

    lkTr          :TxFBTransaction;
    lkDTSMain     :TxFBDataSet;
    lkDSMain      :TDataSource;
    lkDTSData     :TxFBDataSet;
    lkDSData      :TDataSource;
    lkDSDrvData   :TDataSetDriverEh;
    lkMTData      :TMemTableEh;
    lkDSMTData    :TDataSource;
    lkDBG         :TDBGridEh;
    lkCol         :TColumnEh;
    lkAct         :TCustomAction;
  begin
    Result := TAmunhotepForm(TERPForm_Create('', ERP_ObjectIcon(ERP_OBJECTTYPE_DOC), ERP_ObjectBitmap(ERP_OBJECTTYPE_DOC), false, @TERPFormDocEditor_OnClose));
    with TERPForm_Settings(Result) do
      begin
      Values[ERP_SETTINGS_BASETYPE] := IntToStr(ERP_OBJECTTYPE_DOC);
      Values[ERP_DATASET_DBKEY    ] := aJ_ID;
      end;
    lkMainMenu  := TMainMenu(Result.FindComponent(obj_name_erp_mainmenu));
    lkMIMenuMain:= CreateTMenuItem(lkMainMenu.Items,obj_name_erp_mimainmenu,'Приход','','', -1, ERP_MENUITEM_FORM_INDEX_BEGIN);
    // page document
    lkPnlDocHeader := CreateTxcStdPanel(Result, Result, 'pnlDocHeader', '', alTop, 1, 1, 200, 1200, xbsNone);
    lkToolBarDoc   := CreateTxcGradientPanelVistaToolBar(Result, lkPnlDocHeader, '', '', alTop, 1, 1, 22, 200, xbsRaized);

    lkPCDoc        := CreateTxcPageControlEx(Result, Result, obj_name_erp_pagecontrol, 0,36,600,600, alClient);
    lkTSDoc        := CreateTxcTabSheet(lkPCDoc,'tsDocFields'  ,ERP_ObjectCaption(ERP_OBJECTTYPE_DOC), 31,Amunhotep.MainForm.StyleManager.Colors.Foreground);
    lkTSComents    := CreateTxcTabSheet(lkPCDoc,'tsDocComents' ,msg_erp_tsdoccoments                 ,420,Amunhotep.MainForm.StyleManager.Colors.Background);  
    TxcPageControlEx_ActivateDefaultPage(lkPCDoc);
    
    lkToolBarData  := CreateTxcGradientPanelVistaToolBar(Result, lkTSDoc, '', '', alTop, 1, 1, 22, 200, xbsRaized);
    CreateTxFBTransDataSet(Result, obj_name_erp_data_trmain, obj_name_erp_data_dtsmain, 'DataSource'+obj_name_erp_data_dtsmain, ['isc_tpb_read_committed', 'isc_tpb_write', 'isc_tpb_rec_version', 'isc_tpb_nowait'], lkTr, lkDTSMain, lkDSMain);
    with lkDTSMain do
      begin
      AfterOpen   := @TERPFormDocEditor_dtsMain_AfterOpen;
      BeforeClose := @TERPFormDocEditor_dtsMain_BeforeClose;
      end;
    lkDTSData := TxFBDataSet.Create(lkDTSMain);
    with lkDTSData do
      begin
      Name            := obj_name_erp_data_dtsdata;
      Transaction     := lkTr;
      DataSource      := lkDSMain;
      SelectSQL.Text  := StringsLoadFromFile(StrAbsolutePath('../1000014/DOCSQLDATA001S.SQL', ScriptName));
      RefreshSQL.Text := StringsLoadFromFile(StrAbsolutePath('../1000014/DOCSQLDATA001R.SQL', ScriptName));
      InsertSQL.Text  := 
        'INSERT INTO TABL$D_1000014(J_ID, TMC_ID, PRICE, QUANT, PRICE_TMC)'+SQLCRLF+
        '  VALUES(?J_ID, ?TMC_ID, ?PRICE, ?QUANT, ?PRICE_TMC); ';
      ModifySQL.Text  := 
        'UPDATE TABL$D_1000014 D SET '+SQLCRLF+
        '   D.PRICE     = ?PRICE '+SQLCRLF+
        '  ,D.QUANT     = ?QUANT '+SQLCRLF+
        '  ,D.NAME      = ?NAME '+SQLCRLF+
        '  ,D.PRICE_TMC = ?PRICE_TMC '+SQLCRLF+
        'WHERE (D.ID = ?ID) ';
      DeleteSQL.Text  := 
        'DELETE FROM TABL$D_1000014 D '+SQLCRLF+
        'WHERE (D.ID = ?ID) ';
      AfterOpen       := @TERPForm_OpenDataSetsChilds;
      BeforeClose     := @TERPForm_CloseDataSetsChilds;
      end;
    lkDSData := TDataSource.Create(lkDTSData);
    with lkDSData do
      begin
      Name    := 'DataSource'+lkDTSData.Name;
      DataSet := lkDTSData;
      end;  
    lkDSDrvData := TDataSetDriverEh.Create(Result);
    with lkDSDrvData do
      begin
      Name             := 'DataSetDriver'+lkDTSData.Name;
      ProviderDataSet  := lkDTSData;
      ResolveToDataSet := True; 
      end;
    lkMTData := TMemTableEh.Create(lkDTSData);
    with lkMTData do
      begin
      Name             := 'MemoryTable'+lkDTSData.Name;
      DataDriver       := lkDSDrvData;
      CachedUpdates    := false;
      Filtered         := true;
      FetchAllOnOpen   := true;
      MasterDetailSide := mdsOnSelfEh; 
      AfterOpen        := @TERPFormDocEditor_mtData_AfterOpen;
      BeforeClose      := @TERPFormDocEditor_mtData_BeforeClose;
      OnNewRecord      := @TERPFormDocEditor_mtData_OnNewRecord;
      Tag              := 0;
      end;
    lkDSMTData := TDataSource.Create(lkMTData);
    with lkDSMTData do
      begin
      Name    := 'DataSource'+lkMTData.Name;
      DataSet :=  lkMTData;
      end; 
    lkDBG := CreateTDBGridEh(Result, lkTSDoc, lkDSMTData, obj_name_erp_data_dbgdata, 1, 20, 200, 200, alClient);
    with lkDBG do
      begin
      AllowedOperations := [alopInsertEh, alopAppendEh, alopUpdateEh, alopDeleteEh];
      IndicatorOptions  := [gioShowRowIndicatorEh, gioShowRowselCheckboxesEh];  
      Font.Style     := [];
      Options        := Options   + [dgMultiSelect, dgAlwaysShowSelection];  
      OptionsEh      := OptionsEh + [dghFixed3D, dghFrozen3D, dghFooter3D, dghAutoSortMarking, dghMultiSortMarking,  
        dghIncSearch, dghHighlightFocus, dghRowHighlight, dghColumnResize, dghColumnMove, dghExtendVertLines, dghHotTrack];
      SortLocal      := true;
      VTitleMargin   := 4;
      FooterRowCount := 1;
      SumList.Active := true;
      OnKeyDown      := @TERPFormDocEditor_dbgData_OnKeyDown;
      //OnGetCellParams:= @TERPFormDocEditor_dbgData_OnGetCellParams;
      Columns.Clear;
      end; 
    lkCol := CreateTColumnEh(lkDBG,'TMC_ID'     ,'#0'               ,'Товарно-материальные ценности|Код'     , 60,taRightJustify);
    with lkCol do
      begin
      Color         := lkDBG.Color;

      end;
    lkCol := CreateTColumnEh(lkDBG,'TMC_NAME2'  ,''                 ,'Товарно-материальные ценности|Название для РРО',200,taLeftJustify );
    with lkCol do
      begin
      Color         := lkDBG.FixedColor + $202020;
      ReadOnly      := True;
      with Footer do
        begin
        Color         := lkDBG.FixedColor;
        DisplayFormat := '';
        Alignment     := lkCol.Alignment;
        ValueType     := fvtStaticText;
        Value         := 'ИТОГО';
        end;
      with EditButtons.Add do
        begin
        Glyph.LoadFromFile(PrepareAbsoleteFileName('PEAKTOP:IMG/CONFIG/DBGRID/BTN000.BMP'));
        Style   := ebsGlyphEh;
        Hint    := 'Изменить ТМЦ';
        Visible := true;
        OnClick := @TERPFormDocEditor_dbgData_TMC_NAME2_Update_OnClick;
        end;
      AlwaysShowEditButton := true;  
      end;
    lkCol := CreateTColumnEh(lkDBG,'TMC_ARTICLE',''                 ,'Товарно-материальные ценности|Артикул', 80,taLeftJustify );
    with lkCol do
      begin
      Color         := lkDBG.Color;
      end;
    lkCol := CreateTColumnEh(lkDBG,'TMC_BARCODE',''                 ,'Товарно-материальные ценности|Штрихкод',120,taLeftJustify );
    with lkCol do
      begin
      Color         := lkDBG.Color;
      end;
    lkCol := CreateTColumnEh(lkDBG,'EDIZM_SHORT',''                 ,'Товарно-материальные ценности|Ед.'         , 20,taCenter );
    with lkCol do
      begin
      Color         := lkDBG.FixedColor + $202020;
      ReadOnly      := True;
      Font.Size     := 6;
      end;
    lkCol := CreateTColumnEh(lkDBG,'PRICE'      ,'# ### ### ##0.00' ,'Документ|Цена'        , 60,taRightJustify);
    with lkCol do
      begin
      Font.Style := [fsBold];
      end;
    lkCol := CreateTColumnEh(lkDBG,'QUANT'      ,'# ### ### ##0.000','Документ|Кол'         , 60,taRightJustify);
    with lkCol do
      begin
      Font.Style := [fsBold];
      with Footer do
        begin
        Color         := lkCol.Color;
        DisplayFormat := lkCol.DisplayFormat;
        Alignment     := lkCol.Alignment;
        FieldName     := lkCol.FieldName;
        ValueType     := fvtSum;
        end;
      end;
    lkCol := CreateTColumnEh(lkDBG,'TOTAL'      ,'# ### ### ##0.00' ,'Документ|Сумма'       ,72,taRightJustify);
    with lkCol do
      begin
      Color         := lkDBG.FixedColor + $202020;
      ReadOnly      := True;
      with Footer do
        begin
        Color         := lkCol.Color;
        DisplayFormat := lkCol.DisplayFormat;
        Alignment     := lkCol.Alignment;
        FieldName     := lkCol.FieldName;
        ValueType     := fvtSum;
        end;
      end;
    lkCol := CreateTColumnEh(lkDBG,'PRICE_TMC'      ,'# ### ### ##0.00' ,'Справочно|Цена розн.'        , 60,taRightJustify);
    with lkCol do
      begin
      Color := $0080FFFF;
      Font.Style := [fsBold];
      end;
    lkCol := CreateTColumnEh(lkDBG,'PCPRICE'      ,'# ### ### ##0.00' ,  'Справочно|% наценки.'        , 56,taRightJustify);
    with lkCol do
      begin
      Color    := lkDBG.FixedColor + $202020;
      ReadOnly := True;
      end;

    ERP_DBGridEh_StdActions_Create(lkDBG, [erpGrid, erpGridNavigation, erpGridExport], lkToolBarData, nil);

    lkLbl := CreateTLabel(lkPnlDocHeader,lkPnlDocHeader,'Код',2,lkToolBarDoc.Top+lkToolBarDoc.Height+2,20,24,alNone,taLeftJustify);
    lkDBE := TDBEditEh.Create(Result);
    with TDBEditEh(lkDBE)do
      begin 
      Parent     := lkPnlDocHeader;
      AutoSize   := false;
      Ctl3D      := false;
      Flat       := true; 
      Left       := lkLbl.Left + lkLbl.Width + 2;
      Top        := lkLbl.Top;
      Height     := lkLbl.Height;
      Width      := 56; 
      Color      := Amunhotep.MainForm.StyleManager.Colors.Foreground;
      Font.Color := Amunhotep.MainForm.StyleManager.Colors.Border;
      ReadOnly   := true;
      DataSource := lkDSMain;
      DataField  := 'ID';
      Alignment  := taLeftJustify;
      end;
    lkLbl := CreateTLabel(lkPnlDocHeader,lkPnlDocHeader,'Фирма:',lkDBE.Left+lkDBE.Width+2,lkDBE.Top,20,36,alNone,taLeftJustify);
    lkDBE := TDBEditEh.Create(Result);
    with TDBEditEh(lkDBE)do
      begin 
      Parent     := lkPnlDocHeader;
      AutoSize   := false;
      Ctl3D      := false;
      Flat       := true; 
      Left       := lkLbl.Left + lkLbl.Width + 2;
      Top        := lkLbl.Top;
      Height     := lkLbl.Height;
      Width      := 200; 
      Color      := Amunhotep.MainForm.StyleManager.Colors.Window;
      Font.Color := Amunhotep.MainForm.StyleManager.Colors.Border;
      ReadOnly   := true;
      DataSource := lkDSMain;
      DataField  := 'FIRM_ID_';
      Alignment  := taLeftJustify;
      OnDblClick := @TERPFormDocEditor_dbeFIRM_ID__OnDblClick;
      with EditButtons.Add do
        begin
        Glyph.LoadFromFile(PrepareAbsoleteFileName('PEAKTOP:IMG/CONFIG/DBGRID/BTN000.BMP'));
        Style   := ebsGlyphEh;
        Hint    := 'Выбрать';
        Visible := true;
        OnClick := @TERPFormDocEditor_dbeFIRM_ID__OnButtonClick;
        end;
      end;
    lkLbl := CreateTLabel(lkPnlDocHeader,lkPnlDocHeader,'Филиал:',lkDBE.Left+lkDBE.Width+2,lkDBE.Top,20,36,alNone,taLeftJustify);
    lkDBE := TDBEditEh.Create(Result);
    with TDBEditEh(lkDBE)do
      begin 
      Parent     := lkPnlDocHeader;
      AutoSize   := false;
      Ctl3D      := false;
      Flat       := true; 
      Left       := lkLbl.Left + lkLbl.Width + 2;
      Top        := lkLbl.Top;
      Height     := lkLbl.Height;
      Width      := 200; 
      Color      := Amunhotep.MainForm.StyleManager.Colors.Window;
      Font.Color := Amunhotep.MainForm.StyleManager.Colors.Border;
      ReadOnly   := true;
      DataSource := lkDSMain;
      DataField  := 'FILIAL_ID_';
      Alignment  := taLeftJustify;
      OnDblClick := @TERPFormDocEditor_dbeFILIAL_ID__OnDblClick;
      with EditButtons.Add do
        begin
        Glyph.LoadFromFile(PrepareAbsoleteFileName('PEAKTOP:IMG/CONFIG/DBGRID/BTN000.BMP'));
        Style   := ebsGlyphEh;
        Hint    := 'Выбрать';
        Visible := true;
        OnClick := @TERPFormDocEditor_dbeFILIAL_ID__OnButtonClick;
        end;
      end;
    lkLbl := CreateTLabel(lkPnlDocHeader,lkPnlDocHeader,'Дата',lkDBE.Left+lkDBE.Width+2,lkDBE.Top,20,32,alNone,taLeftJustify);
    lkDBE := TDBDateTimeEditEh.Create(Result);
    with TDBDateTimeEditEh(lkDBE)do
      begin 
      Parent     := lkPnlDocHeader;
      AutoSize   := false;
      Ctl3D      := false;
      Flat       := true; 
      Left       := lkLbl.Left + lkLbl.Width + 2;
      Top        := lkLbl.Top;
      Height     := 20;
      Width      := 140; 
      Color      := Amunhotep.MainForm.StyleManager.Colors.Window;
      Font.Color := Amunhotep.MainForm.StyleManager.Colors.Border;
      Kind       := dtkDateTimeEh;
      DataSource := lkDSMain;
      DataField  := 'DATE_COMMIT';
      Alignment  := taLeftJustify;
      end;

    lkLbl := CreateTLabel(lkPnlDocHeader,lkPnlDocHeader,'Тип документа',2, lkDBE.Top+lkDBE.Height+4,20,80,alNone,taLeftJustify);
    lkDBE := TDBEditEh.Create(Result);
    with TDBEditEh(lkDBE)do
      begin 
      Parent     := lkPnlDocHeader;
      AutoSize   := false;
      Ctl3D      := false;
      Flat       := true; 
      Left       := lkLbl.Left + lkLbl.Width + 2;
      Top        := lkLbl.Top;
      Height     := lkLbl.Height;
      Width      := 200; 
      Color      := Amunhotep.MainForm.StyleManager.Colors.Window;
      Font.Color := Amunhotep.MainForm.StyleManager.Colors.Border;
      ReadOnly   := true;
      DataSource := lkDSMain;
      DataField  := 'TYPE_ID_';
      Alignment  := taLeftJustify;
      OnDblClick := @TERPFormDocEditor_dbeTYPE_ID__OnDblClick;
      with EditButtons.Add do
        begin
        Glyph.LoadFromFile(PrepareAbsoleteFileName('PEAKTOP:IMG/CONFIG/DBGRID/BTN000.BMP'));
        Style   := ebsGlyphEh;
        Hint    := 'Выбрать';
        Visible := true;
        OnClick := @TERPFormDocEditor_dbeTYPE_ID__OnButtonClick;
        end;
      end;
    lkLbl := CreateTLabel(lkPnlDocHeader,lkPnlDocHeader,'Примечание:',lkDBE.Left+lkDBE.Width+2,lkDBE.Top,20,72,alNone,taLeftJustify);
    lkDBE := TDBEditEh.Create(Result);
    with TDBEditEh(lkDBE)do
      begin 
      Parent     := lkPnlDocHeader;
      AutoSize   := false;
      Ctl3D      := false;
      Flat       := true; 
      Left       := lkLbl.Left + lkLbl.Width + 2;
      Top        := lkLbl.Top;
      Height     := lkLbl.Height;
      Width      := 400; 
      Color      := Amunhotep.MainForm.StyleManager.Colors.Window;
      Font.Color := Amunhotep.MainForm.StyleManager.Colors.Border;
      ReadOnly   := true;
      DataSource := lkDSMain;
      DataField  := 'NAME';
      Alignment  := taLeftJustify;
      end;

    lkLbl := CreateTLabel(lkPnlDocHeader,lkPnlDocHeader,'Контрагент:',2, lkDBE.Top+lkDBE.Height+4,20,80,alNone,taLeftJustify);
    lkDBE := TDBEditEh.Create(Result);
    with TDBEditEh(lkDBE)do
      begin 
      Parent     := lkPnlDocHeader;
      AutoSize   := false;
      Ctl3D      := false;
      Flat       := true; 
      Left       := lkLbl.Left + lkLbl.Width + 2;
      Top        := lkLbl.Top;
      Height     := lkLbl.Height;
      Width      := 200; 
      Color      := Amunhotep.MainForm.StyleManager.Colors.Window;
      Font.Color := Amunhotep.MainForm.StyleManager.Colors.Border;
      ReadOnly   := true;
      DataSource := lkDSMain;
      DataField  := 'CS_ID_';
      Alignment  := taLeftJustify;
      OnDblClick := @TERPFormDocEditor_dbeCS_ID__OnDblClick;
      with EditButtons.Add do
        begin
        Glyph.LoadFromFile(PrepareAbsoleteFileName('PEAKTOP:IMG/CONFIG/DBGRID/BTN000.BMP'));
        Style   := ebsGlyphEh;
        Hint    := 'Выбрать';
        Visible := true;
        OnClick := @TERPFormDocEditor_dbeCS_ID__OnButtonClick;
        end;
      end;
    lkLbl := CreateTLabel(lkPnlDocHeader,lkPnlDocHeader,'Входящий номер:',lkDBE.Left+lkDBE.Width+2,lkDBE.Top,20,96,alNone,taLeftJustify);
    lkDBE := TDBEditEh.Create(Result);
    with TDBEditEh(lkDBE)do
      begin 
      Parent     := lkPnlDocHeader;
      AutoSize   := false;
      Ctl3D      := false;
      Flat       := true; 
      Left       := lkLbl.Left + lkLbl.Width + 2;
      Top        := lkLbl.Top;
      Height     := lkLbl.Height;
      Width      := 124; 
      Color      := Amunhotep.MainForm.StyleManager.Colors.Window;
      Font.Color := Amunhotep.MainForm.StyleManager.Colors.Border;
      ReadOnly   := true;
      DataSource := lkDSMain;
      DataField  := 'DOCNUMBERIN';
      Alignment  := taLeftJustify;
      end;
    lkLbl := CreateTLabel(lkPnlDocHeader,lkPnlDocHeader,'Вход. дата',lkDBE.Left+lkDBE.Width+2,lkDBE.Top,20,56,alNone,taLeftJustify);
    lkDBE := TDBDateTimeEditEh.Create(Result);
    with TDBDateTimeEditEh(lkDBE)do
      begin 
      Parent     := lkPnlDocHeader;
      AutoSize   := false;
      Ctl3D      := false;
      Flat       := true; 
      Left       := lkLbl.Left + lkLbl.Width + 2;
      Top        := lkLbl.Top;
      Height     := 20;
      Width      := 80; 
      Color      := Amunhotep.MainForm.StyleManager.Colors.Window;
      Font.Color := Amunhotep.MainForm.StyleManager.Colors.Border;
      Kind       := dtkDateEh;
      DataSource := lkDSMain;
      DataField  := 'DATE_IN';
      Alignment  := taLeftJustify;
      end;

    lkLbl := CreateTLabel(lkPnlDocHeader,lkPnlDocHeader,'Склад:',2, lkDBE.Top+lkDBE.Height+4,20,80,alNone,taLeftJustify);
    lkDBE := TDBEditEh.Create(Result);
    with TDBEditEh(lkDBE)do
      begin 
      Parent     := lkPnlDocHeader;
      AutoSize   := false;
      Ctl3D      := false;
      Flat       := true; 
      Left       := lkLbl.Left + lkLbl.Width + 2;
      Top        := lkLbl.Top;
      Height     := lkLbl.Height;
      Width      := 200; 
      Color      := Amunhotep.MainForm.StyleManager.Colors.Window;
      Font.Color := Amunhotep.MainForm.StyleManager.Colors.Border;
      ReadOnly   := true;
      DataSource := lkDSMain;
      DataField  := 'PLACE_ID_';
      Alignment  := taLeftJustify;
      OnDblClick := @TERPFormDocEditor_dbePLACE_ID__OnDblClick;
      with EditButtons.Add do
        begin
        Glyph.LoadFromFile(PrepareAbsoleteFileName('PEAKTOP:IMG/CONFIG/DBGRID/BTN000.BMP'));
        Style   := ebsGlyphEh;
        Hint    := 'Выбрать';
        Visible := true;
        OnClick := @TERPFormDocEditor_dbePLACE_ID__OnButtonClick;
        end;
      end;
    lkLbl := CreateTLabel(lkPnlDocHeader,lkPnlDocHeader,'Налоговая модель:',lkDBE.Left+lkDBE.Width+2,lkDBE.Top,20,96,alNone,taLeftJustify);
    lkDBE := TDBEditEh.Create(Result);
    with TDBEditEh(lkDBE)do
      begin 
      Parent     := lkPnlDocHeader;
      AutoSize   := false;
      Ctl3D      := false;
      Flat       := true; 
      Left       := lkLbl.Left + lkLbl.Width + 2;
      Top        := lkLbl.Top;
      Height     := lkLbl.Height;
      Width      := 140; 
      Color      := Amunhotep.MainForm.StyleManager.Colors.Window;
      Font.Color := Amunhotep.MainForm.StyleManager.Colors.Border;
      ReadOnly   := true;
      DataSource := lkDSMain;
      DataField  := 'TAX_ID_';
      Alignment  := taLeftJustify;
      OnDblClick := @TERPFormDocEditor_dbeTAX_ID__OnDblClick;
      with EditButtons.Add do
        begin
        Glyph.LoadFromFile(PrepareAbsoleteFileName('PEAKTOP:IMG/CONFIG/DBGRID/BTN000.BMP'));
        Style   := ebsGlyphEh;
        Hint    := 'Выбрать';
        Visible := true;
        OnClick := @TERPFormDocEditor_dbeTAX_ID__OnButtonClick;
        end;
      end;
    lkLbl.Visible := false;
    lkDBE.Visible := false; 
    lkPnlDocHeader.Height := lkDBE.Top + lkDBE.Height + 4; 

    lkAct := TERPForm_CreateAction2(Result,obj_name_erp_actviewrefresh ,msg_erp_actviewrefresh,msg_erp_actviewrefresh_hint  ,SHORTCUT_DATA_REFRESH,0,170,@TERPFormDocEditor_actRefresh_OnExecute       ,nil                                    ,lkToolBarDoc , 80,lkMIMenuMain);
    lkAct := TERPForm_CreateAction2(Result,obj_name_erp_actcommit      ,msg_erp_actcommit     ,msg_erp_actcommit_hint       ,SHORTCUT_DOC_COMMIT  ,0,298,@TERPFormDocEditor_actCommit_OnExecute       ,@TERPFormDocEditor_actCommit_OnUpdate  ,lkToolBarDoc , 72,lkMIMenuMain);
    lkAct := TERPForm_CreateAction2(Result,obj_name_erp_actuncommit    ,msg_erp_actuncommit   ,msg_erp_actuncommit_hint     ,SHORTCUT_DOC_UNCOMMIT,0,297,@TERPFormDocEditor_actUnCommit_OnExecute     ,@TERPFormDocEditor_actUnCommit_OnUpdate,lkToolBarDoc , 72,lkMIMenuMain);
    lkAct := TERPForm_CreateAction2(Result,obj_name_erp_actprintdefault,msg_erp_actprintitem  ,msg_erp_actprintitem_hint    ,SHORTCUT_PRINT       ,0,105,@TERPFormDocEditor_actPrint_OnExecute        ,nil                                    ,lkToolBarDoc , 60,lkMIMenuMain);
    lkAct := TERPForm_CreateAction2(Result,obj_name_erp_actdocgotojrnl ,msg_erp_actdocgotojrnl,msg_erp_actdocgotojrnl_hint  ,SHORTCUT_DOC_GOTOJRNL,0,519,@TERPFormDocEditor_actJrnl_OnExecute         ,nil                                    ,lkToolBarDoc , 68,lkMIMenuMain);
    lkAct := TERPForm_CreateAction2(Result,obj_name_erp_actdoccnd      ,msg_erp_actdoccnd     ,msg_erp_actdoccnd_hint       ,''                   ,0, 46,@TERPFormDocEditor_actCnd_OnExecute          ,nil                                    ,lkToolBarDoc , 72,lkMIMenuMain);

    lkAct := TERPForm_CreateAction2(Result,obj_name_erp_actins         ,'Добавить'            ,'Добавить ТМЦ из справочника',SHORTCUT_DATA_INSERT ,0,307,@TERPFormDocEditor_actTMCIns_OnExecute       ,nil                                    ,lkToolBarData, 80,lkMIMenuMain);
    lkAct := TERPForm_CreateAction2(Result,obj_name_erp_actupd         ,'Редактировать'       ,'Редактировать карточку ТМЦ' ,SHORTCUT_DATA_EDIT   ,0,313,@TERPFormDocEditor_actTMCEdit_OnExecute      ,nil                                    ,lkToolBarData,120,lkMIMenuMain);
    lkAct := TERPForm_CreateAction2(Result,obj_name_erp_actdel         ,'Удалить'             ,'Удалить Т.М.Ц из документа' ,SHORTCUT_DATA_DELETE ,0,309,@TERPFormDocEditor_actTMCDel_OnExecute       ,@TERPFormDocEditor_actCommit_OnUpdate  ,lkToolBarData, 80,lkMIMenuMain);

    Amunhotep.MainForm.xcMenu.AddMenu(lkMainMenu); lkMainMenu.OwnerDraw := true;
    Result.Menu := lkMainMenu;
    Result.OnResize := @TERPFormDocEditor_OnResize;

    DocComentsIntf_Create(Result, lkTSComents, lkDSMain);
    TERPFormDocEditor_RefreshView(Result);    // refresh doc
    TERPFormDocEditor_OnResize(Result);       // refresh client area repaint
  end;
  //============================================================================
var
  lkJ_ID :string;
begin
  MaterialColors[0] := $3643F4;  //$F44336;
  MaterialColors[1] := $631EE9;  //$E91E63;
  MaterialColors[2] := $B73A67;  //$673AB7;
  MaterialColors[3] := $F39621;  //$2196F3;
  MaterialColors[4] := $889600;  //$009688;
  MaterialColors[5] := $2257FF;  //$FF5722;
  MaterialColors[6] := $B0279C;  //$9C27B0;
  MaterialColors[7] := $485579;  //$795548;
  MaterialColors[8] := $B5513F;  //$3F51B5;
  MaterialColors[9] := $8B7D60;  //$607D8B;
  lkJ_ID := GetGlobalVariable('J_ID');
  WriteLn(lkJ_ID); 

  TERPFormDocEditor_Create(GetGlobalVariable('J_ID'));
end.
